<html>
<head>
    <title>Vorbeste cu Mine!</title>
    <link href="favicon.png" rel="icon" type="image/png">
    <meta charset="UTF-8">
    <style>
        body {
            background: lightgrey;
            margin: 0.5%;
        }

        * {
            -webkit-touch-callout: none;
        }

        :fullscreen, ::backdrop {
            background-color: rgba(255, 255, 255, 0);
            padding: 8px;
        }

        button {
            cursor: pointer;
            font-size: 20pt;
        }


        #text {
            border: 3px solid lightgrey;
            padding: 5pt;
            width: 100%;
        }

        .top-button {
            height: 42pt;
            width: 7%;
            position: absolute;
            border: 3px solid lightgrey;
            right: 0;
            font-size: 250%;
        }

        button#backspace {
            margin-right: 0.5%;
        }

        button#edit {
            margin-right: 7.5%;
        }

        button#speak {
            margin-right: 14.5%;
        }

        button#fullscreen {
            margin-right: 21.5%;
        }

        div#canvas {
            background: white;
        }

        @media (orientation: landscape) {
            div#canvas div {
                width: 16.66%;
            }

            #text {
                font-size: 200%;
            }
        }

        @media (orientation: portrait) {
            div#canvas div {
                width: 25%;
            }

            #text {
                font-size: 400%;
            }

            .top-button {
                height: 70pt;
                width: 7%;
            }
        }

        div#canvas div {
            display: inline-block;
            /*width: 16.66%;*/
            /*width: 33.3%;*/
            object-fit: cover;
            position: relative;
        }

        div#canvas img {
            display: inline-block;
            box-sizing: border-box;
            border: 5px solid lightgrey;
            width: 100%;
        }

        div#canvas div.plus::before {
            content: '';
            position: absolute;
            z-index: 10;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            border: 5px solid lightgrey;
            pointer-events: none;
            background-image: url('plus.png');
            background-size: cover;
        }
    </style>
    <script src="image-edit.js" type="text/javascript"></script>
    <script src="google-key.js" type="text/javascript"></script>
</head>
<body>
<input id="text" readonly="readonly" tabindex="-1" type="text"/>
<button class="top-button" id="fullscreen"
        onclick="document.body.requestFullscreen(); this.style.display='none';"
        title="Fullscreen"> ‚ÜïÔ∏è</button>
<button class="top-button" id="speak" onclick="speak();" tabindex="-1" title="Speak"> üì¢</button>
<button class="top-button" id="edit" onclick="toggleEdit();" tabindex="-1" title="Change Image"> ‚úçÔ∏è</button>
<button class="top-button" id="backspace" onclick="stergeTot();" tabindex="-1"> ‚å´</button>
<br>
<div id="canvas">
</div>

<input id="fileInput" style="display: none" type="file"/>

<script>
    const topItems = [
        {
            img: 'eat.jpg', text: 'vreau', children: [
                {img: 'banana.jpg', text: 'bananƒÉ'},
                {img: 'sticks.jpg', text: 'sticks'},
                {img: 'chips.jpg', text: 'lays'},
                {img: 'pomber.jpg', text: 'pomber'},
                {img: 'eggs.jpg', text: 'omleta'},
                {img: 'bread-butter.png', text: 'p√¢ine cu unt'},
                {img: 'grape.jpg', text: 'struguri'},
                {img: 'apple.jpg', text: 'mƒÉr'},
                {img: 'soup.jpg', text: 'supƒÉ'},
                {img: 'blueberry.jpg', text: 'afine'},
                {img: 'pure.png', text: 'piure'},
                {img: 'pasta.png', text: 'paste'},
                {img: 'pizza.png', text: 'pizza'},
                {img: 'strawberry.png', text: 'cƒÉp»ôuni'},
                {img: 'iogurt.png', text: 'iaurt'},
            ]
        },
        {
            img: 'drink.jpg', text: 'vreau sƒÉ beau', children: [
                {img: 'water.jpg', text: 'apƒÉ'},
                {img: 'milk.jpg', text: 'lapte'},
                {img: 'tea.jpg', text: 'ceai'},
                {img: 'juice.png', text: 'suc'},
            ]
        },
        {
            text: 'vreau', img: 'want.jpg', children: [
                {img: 'bombons.jpg', text: 'bomboane'},
                {img: 'outside.png', text: 'sƒÉ merg'},
                {img: 'sleep.jpg', text: 'sƒÉ dorm'},
                {img: 'mom.jpg', text: 'la mama'},
                {img: 'dad.jpg', text: 'la tata'},
                {img: 'emma.jpg', text: 'Emma'},
                {img: 'hug.png', text: 'pupic'},
                {img: 'bath.jpg', text: 'baie'},
                {img: 'wc.jpg', text: 'pipi'},
                {img: 'music.jpg', text: 'muzicƒÉ'},
                {img: 'book.png', text: 'cartea muzicala'},
                {img: 'toys.png', text: 'jucƒÉrii'},
                {img: 'board.png', text: 'placa cu vibratii'},
                {img: 'd.png', text: 'D-ul'},
                {img: 'phone.png', text: 'telefon'},
                {img: 'my-room.png', text: 'acasƒÉ'},
                {img: 'koala.png', text: 'koala'},

            ]
        },
        {
            img: 'feel.jpg', text: "mƒÉ simt", children: [
                {img: 'happy.png', text: 'fericit'},
                {img: 'heart.png', text: 'te iubesc'},
                {img: 'sad.png', text: 'trist'},
                {img: 'cold.jpg', text: 'mi-e rece'},
                {img: 'hot.jpg', text: 'mi-e cald'},
                {img: 'angry.png', text: 'supƒÉrat'},
                {img: 'wet.jpg', text: 'ud'},
                {
                    img: 'auch.jpg', text: 'mƒÉ doare', children: [
                        {img: 'hand.png', text: 'm√¢na'},
                        {img: 'foot.png', text: 'picior'},
                        {img: 'head.png', text: 'cap'},
                        {img: 'teeth.png', text: 'din»õi'},
                        {img: 'throat.png', text: 'g√¢t'},
                        {img: 'ear.png', text: 'ureche'},
                        {img: 'belly.png', text: 'burtƒÉ'},
                    ]
                },
            ]
        },
        {img: 'enough.jpg', text: 'gata'},
        {img: 'cant.png', text: 'Nu pot!'},
        {img: 'pointing.png', text: 'Arata!'},
        {img: 'change.png', text: 'Altceva!'},
        {img: 'pause.png', text: 'Pauza'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'yes.jpg', text: 'da'},
        {img: 'no.jpg', text: 'nu'},
    ];
    const homeItem = {img: 'home.png', children: topItems};

    const textE = document.getElementById('text');
    const itemsPerPage = 18;
    function addHome(items) {
        for (let item of items) {
            if (item.children) {
                addHome(item.children);
            }
        }
        while (items.length < itemsPerPage - 1) {
            items.push({img: 'white.jpg'});
        }
        items.push(homeItem);
    }

    addHome(topItems);

    const canvasE = document.getElementById('canvas');

    var imageIdUnderEdit = "";

    function setCanvas(items) {
        canvasE.innerHTML = '';
        for (let item of items) {
            let div = document.createElement('div');
            if (item.children) div.className = "plus";

            let img = document.createElement('img');
            img.id = item.img;
            img.src = localStorage.getItem(item.img) ?? item.img;
            img.onclick = function () {
                if (editMode) {
                    imageIdUnderEdit = img.id;
                    fileInputE.click();
                    toggleEdit();
                    return;
                }
                if (item.text) prompt(item.text);
                if (item.children) setCanvas(item.children);
                else if (item.text) {
                    setCanvas(topItems);
                    simplifyText().then(() => speak());
                }
            }
            canvasE.appendChild(div);
            div.appendChild(img);
        }
    }

    setCanvas(topItems);

    function prompt(text) {
        textE.value += ' ' + text;
    }

    function stergeTot() {
        if (editMode) {
            localStorage.clear();
            toggleEdit();
            setCanvas(topItems);
        } else {
            textE.value = "";
        }
    }

    document.onfullscreenchange = function () {
        if (!document.fullscreenElement) {
            let button = document.querySelector('#fullscreen');
            button.focus();
            button.style.display = 'inline';
            button.focus();
        }
    }

    const aiPrompt = `Context: Urmatorul text a fost scris intr-o aplicatie AAC apasand pe imagini.
    Persoana are o sora pe nume Emma.
    Gaseste o forma corecta gramatical, fara a adauga pe cat posibil cuvinte in plus sau repetitii.

    Acesta este textul introdus:
 `;

    function simplifyText() {
        return geminiAI(aiPrompt + textE.value)
            .then((aiResponse) => {
                textE.value = aiResponse;
            })
    }

    function geminiAI(prompt) {
        return fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=" + geminiApiKey, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                "contents": [{
                    "parts": [{
                        "text": prompt
                    }]
                }]
            })
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error, status = ${response.status}`);
                }
                return response.json();
            })
            .then((json) => {
                return json.candidates[0].content.parts[0].text;
            });
    }

    let speakRequest = null;
    let audio = null;

    function speak() {
        if (speakRequest) try {
            speakRequest.abort();
        } catch (e) {
        }
        if (audio) try {
            audio.pause();
        } catch (e) {
        }

        speakRequest = fetch("https://texttospeech.googleapis.com/v1/text:synthesize?key=" + googleApiKey, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                "audioConfig": {
                    "audioEncoding": "LINEAR16",
                    "effectsProfileId": [
                        "small-bluetooth-speaker-class-device"
                    ],
                    "pitch": 0,
                    "speakingRate": 1
                },
                "input": {
                    "text": textE.value
                },
                "voice": {
                    "languageCode": "ro-RO",
                    "name": "ro-RO-Wavenet-A"
                }
            })
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error, status = ${response.status}`);
                }
                return response.json(); // base64 encoded
            })
            .then((json) => json.audioContent)
            .then((audioContent) => {
                if (audio) {
                    try {
                        audio.pause();
                    } catch (e) {
                    }
                }
                audio = new Audio("data:audio/wav;base64," + audioContent);
                audio.play();
            });
    }

    const fileInputE = document.getElementById('fileInput');
    fileInputE.addEventListener('change', function () {
        const file = fileInputE.files[0];
        if (!file) return;
        const reader = new FileReader();

        reader.onload = function (event) {
            const imageData = event.target.result;
            crop(imageData, 1)
                .then(imageUrl => {
                    console.log("Before:", imageUrl);
                    return resizeImage(imageUrl);
                })
                .then(imageUrl => {
                    console.log("After:", imageUrl);
                    let editedImgE = document.getElementById(imageIdUnderEdit);
                    editedImgE.src = imageUrl;
                    localStorage.setItem(imageIdUnderEdit, imageUrl);
                });
        };

        reader.onerror = function () {
            alert("Could not load file.");
        };

        reader.readAsDataURL(file);
    });

    let editMode = false;
    function toggleEdit() {
        editMode = !editMode;
        document.getElementById("edit").style.background = editMode ? "red" : "";
        document.getElementById("backspace").style.background = editMode ? "yellow" : "";
    }
</script>
</body>
</html>
