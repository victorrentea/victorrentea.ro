<html>
<head>
    <title>Vorbeste, Vlad!</title>
    <link href="favicon3.png" rel="icon" type="image/png">
    <meta charset="UTF-8">
    <style>
        body {
            background: lightgrey;
            margin: 0.5%;
        }

        * {
            -webkit-touch-callout: none;
        }

        button {
            cursor: pointer;
            font-size: 20pt;
        }



        #bottom-button-bar {
            width: 100%;
            text-align: center;
            position: absolute;
            bottom: 0
        }

        #bottom-button-bar button {
            background-color: white;
            box-shadow: 0 0 5px 0;
        }

        :fullscreen, ::backdrop {
            background-color: rgba(255, 255, 255, 0);
            padding: 8px;
        }

        #text {
            font-size: 200%;
            border: 3px solid lightgrey;
            padding: 5pt;
            width: 100%;
        }

        .top-button {
            position: absolute;
            height: 42pt;
            border: 3px solid lightgrey;
            width: 7%;
            right: 0;
            font-size: 250%;
        }
        button#backspace {
            margin-right: 0.5%;
        }

        button#edit {
            margin-right: 7.5%;
        }
        button#speak {
            margin-right: 14.5%;
        }
        button#fullscreen{
            margin-right: 21.5%;
        }

        div#canvas {
            background: white;
        }
        div#canvas div{
            display: inline-block;
            width: 16.66%;
            position: relative;
            /*width: 12.5%;*/
        }
        div#canvas img{
            display: inline-block;
            box-sizing: border-box;
            border: 5px solid lightgrey;
            width: 100%;
        }

        div#canvas div.plus::before {
            content: '';
            position: absolute;
            z-index: 10;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            border: 5px solid lightgrey;
            pointer-events: none;
            background-image: url('plus.png');
            background-size: cover;
        }
    </style>
</head>
<body>
<div id="bottom-button-bar">
    <button autofocus id="fullscreen-button" onclick="document.body.requestFullscreen(); this.style.display='none';">
        Fullscreen
    </button>
    <!--<button onclick="speakOpenAI(document.getElementById('text').value || 'Vreau sƒÉ dorm!')"> Speak OpenAIÔ∏è</button>-->
<!--    <button onclick="speakGoogle(document.getElementById('text').value || 'Vreau sƒÉ dorm!')"> Speak Google</button>-->
</div>
<input id="text" tabindex="-1" readonly="readonly" type="text"/>
<!--<div class="top-buttons">-->
    <button id="fullscreen" title="Fullscreen" class="top-button" tabindex="-1" onclick="document.body.requestFullscreen(); this.style.display='none';"> ‚ÜïÔ∏è </button>
    <button id="speak" title="Speak" class="top-button" tabindex="-1" onclick="speak();"> üì¢ </button>
    <button id="edit" style="background: " title="Change Image" class="top-button" tabindex="-1" onclick="toggleEdit();"> ‚úçÔ∏è </button>
    <button id="backspace" class="top-button" tabindex="-1"
            onclick="stergeTot(); event.returnValue = false;"
            ontouchstart="stergeTot(); event.returnValue = false;"
    > ‚å´ </button>
<!--</div>-->
    <!--        ontouchstart="stergeCuvant(); event.returnValue = false;"-->
    <!--        ontouchend="onStergeDown();event.returnValue = false;"-->
    <!--        ontouchmove="event.returnValue = false;"-->
    <!--        ontouchcancel="event.returnValue = false;"-->
    <!--        onclick="stergeCuvant();event.returnValue = false;"-->
    <!--        onmousedown="onStergeDown();event.returnValue = false;"-->



<br>
<div id="canvas">

</div>
<div id="images">

</div>
<!--<input id="custom-image-file" type="file" />
<button onclick="changePicture()"></button>-->

<!--<img src="bed.png" onerror="errors.push(src)">-->

<input type="file" id="fileInput" />
<pre id="fileContent" style="white-space: pre-wrap; border: 1px solid #ccc; padding: 10px;"></pre>
<img id="test">

<script>
    // Get references to the file input and display area
    const fileInputE = document.getElementById('fileInput');
    const fileContent = document.getElementById('fileContent');
    const testimg = document.getElementById("test");

    var imageOverrides = {};
    // localStorage.

    fileInputE.addEventListener('change', function () {
        const file = fileInputE.files[0];
        if (!file) return;
        const reader = new FileReader();

        reader.onload = function (event) {
            fileContent.textContent = event.target.result; // Display file content
            // test.src=event.target.result;
            let editedImgE = document.getElementById(imageIdUnderEdit);
            editedImgE.src=event.target.result;
            // imageOverrides[imageIdUnderEdit]=event.target.result;
            localStorage.setItem(imageIdUnderEdit, event.target.result);
        };

        reader.onerror = function () {
            alert("Could not load file.");
        };

        reader.readAsDataURL(file);
    });
    var editMode=false;
    const editButtonE=document.getElementById("edit");
    function toggleEdit() {
        editMode = !editMode;
        editButtonE.style.background=editMode?"red":"";
    }

    //https://stackoverflow.com/questions/42160260/prevent-force-touch-event-on-image-but-still-allow-long-press-event-in-ios-safar
    window.addEventListener('touchforcechange', function (event) {
        var force = event.changedTouches[0].force;
        var id = event.changedTouches[0].target.id;

        if ($('#' + id).hasClass('class') && force > 0.1) {
            event.preventDefault();
            console.log('prevented 3D touch on element with id = ' + id);
        }
    });


    const textE = document.getElementById('text');
    const itemsPerPage = 18;
    const topItems = [
        {
            img: 'eat.jpg', text: 'vreau', children: [
                {img: 'banana.jpg', text: 'bananƒÉ'},
                {img: 'sticks.jpg', text: 'sticks'},
                {img: 'lays.jpg', text: 'lays'},
                {img: 'pomber.jpg', text: 'pomber'},
                {img: 'eggs.jpg', text: 'ouƒÉ'},
                {img: 'bread-butter.png', text: 'p√¢ine cu unt'},
                {img: 'grape.jpg', text: 'struguri'},
                {img: 'apple.jpg', text: 'mƒÉr'},
                {img: 'soup.jpg', text: 'supƒÉ'},
                {img: 'blueberry.jpg', text: 'afine'},
                {img: 'pure.png', text: 'piure'},
                {img: 'pasta.png', text: 'paste'},
                {img: 'pizza.png', text: 'pizza'},
                {img: 'strawberry.png', text: 'cƒÉp»ôuni'},
                {img: 'iogurt.png', text: 'iaurt'},
            ]
        },
        {
            img: 'drink.jpg', text: 'vreau sƒÉ beau', children: [
                {img: 'water.jpg', text: 'apƒÉ'},
                {img: 'milk.jpg', text: 'lapte'},
                {img: 'tea.jpg', text: 'ceai'},
                {img: 'juice.png', text: 'suc'},
            ]
        },
        {
            text: 'vreau', img: 'want.jpg', children: [
                {img: 'bombons.png', text: 'bomboane'},
                {img: 'outside.png', text: 'sƒÉ merg'},
                {img: 'sleep.jpg', text: 'sƒÉ dorm'},
                {img: 'mom.jpg', text: 'la mama'},
                {img: 'dad.jpg', text: 'la tata'},
                {img: 'emma.jpg', text: 'Emma'},
                {img: 'hug.png', text: 'pupic'},
                {img: 'bath.jpg', text: 'baie'},
                {img: 'wc.jpg', text: 'toaletƒÉ'},
                {img: 'music.jpg', text: 'muzicƒÉ'},
                {img: 'book.png', text: 'cartea muzicala'},
                {img: 'toys.png', text: 'jucƒÉrii'},
                {img: 'board.png', text: 'placa cu vibratii'},
                {img: 'd.png', text: 'D-ul'},
                {img: 'phone.png', text: 'telefon'},
                {img: 'my-room.png', text: 'acasƒÉ'},
                {img: 'koala.png', text: 'koala'},

            ]
        },
        {
            img: 'feel.jpg', text: "mƒÉ simt", children: [
                {img: 'happy.png', text: 'fericit'},
                {img: 'heart.png', text: 'te iubesc'},
                {img: 'sad.png', text: 'trist'},
                {img: 'cold.jpg', text: 'mi-e rece'},
                {img: 'hot.jpg', text: 'mi-e cald'},
                {img: 'angry.png', text: 'supƒÉrat'},
                {img: 'wet.jpg', text: 'ud'},
                {
                    img: 'auch.jpg', text: 'mƒÉ doare', children: [
                        {img: 'hand.png', text: 'm√¢na'},
                        {img: 'foot.png', text: 'picior'},
                        {img: 'head.png', text: 'cap'},
                        {img: 'teeth.png', text: 'din»õi'},
                        {img: 'throat.png', text: 'g√¢t'},
                        {img: 'ear.png', text: 'ureche'},
                        {img: 'belly.png', text: 'burtƒÉ'},
                    ]
                },
            ]
        },
        {img: 'enough.jpg', text: 'gata'},
        {img: 'cant.png', text: 'Nu pot!'},
        {img: 'pointing.png', text: 'Arata!'},
        {img: 'change.png', text: 'Altceva!'},
        {img: 'pause.png', text: 'Pauza'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'yes.jpg', text: 'da'},
        {img: 'no.jpg', text: 'nu'},
    ];
    const homeItem = {img: 'home.png', children: topItems};

    function addHome(items) {
        for (let item of items) {
            if (item.children) {
                addHome(item.children);
            }
        }
        while (items.length < itemsPerPage - 1) {
            items.push({img: 'white.jpg'});
        }
        items.push(homeItem);
    }

    addHome(topItems);

    const canvasE = document.getElementById('canvas');

    var imageIdUnderEdit = "";
    var imgPressTimer = null;
    function setCanvas(items) {
        canvasE.innerHTML = '';
        for (let item of items) {
            let div = document.createElement('div');
            if (item.children) div.className="plus";

            let img = document.createElement('img');
            img.id = item.img;
            // img.src = imageOverrides[item.img] ?? item.img;
            img.src = localStorage.getItem(item.img) ?? item.img;
            img.onclick = function () {
                if (editMode) {
                    imageIdUnderEdit=img.id;
                    fileInputE.click();
                    toggleEdit();
                    return;
                }
                if (item.text) prompt(item.text);
                if (item.children) setCanvas(item.children);
                else if (item.text) {
                    setCanvas(topItems);
                    simplifyText().then(() => speak());
                }
            }
            canvasE.appendChild(div);
            div.appendChild(img);
        }
    }

    setCanvas(topItems);


    // remove spaces between <img> <img>
    const imagesE = document.getElementById('images');
    imagesE.innerHTML = imagesE.innerHTML.replace(/>\s+</g, '><');
    for (let img of imagesE.children) {
        img.onclick = function () {
            prompt(img.alt);
        }
    }


    function prompt(text) {
        textE.value += ' ' + text;
    }

    function stergeTot() {
        if (editMode) {
            // imageOverrides={};
            localStorage.clear();
            toggleEdit();
            setCanvas(topItems);
        } else {
            textE.value = "";
        }
    }

    function stergeCuvant() {
        let pozitieUltimSpatiu = textE.value.lastIndexOf(" ");
        textE.value = textE.value.substring(0, pozitieUltimSpatiu);
        clearTimeout(timerDown);
    }

    var timerDown = null;

    function onStergeDown() {
        timerDown = setTimeout(() => {
            textE.value = "";
        }, 500);
    }

    document.onfullscreenchange = function () {
        if (!document.fullscreenElement) {
            let button = document.querySelector('#fullscreen-button');
            button.style.display = 'inline';
            // button.focus();

            button = document.querySelector('#fullscreen');
            button.style.display = 'inline';
            button.focus();
        }
    }

    var googleRequest = null;
    var audio = null;
    function speakGoogle(text) {
        const googleApiKey = "AIzaSyDCRBksTm_8-MB-xr55MasWtXUyFpnd3Kc";
        if (googleRequest) {
            try {
                googleRequest.abort();
            } catch (e) {
            }
        }
        if (audio) {
            try {
                audio.pause();
            } catch (e) {
            }
        }
        googleRequest = fetch("https://texttospeech.googleapis.com/v1/text:synthesize?key=" + googleApiKey, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                "audioConfig": {
                    "audioEncoding": "LINEAR16",
                    "effectsProfileId": [
                        "small-bluetooth-speaker-class-device"
                    ],
                    "pitch": 0,
                    "speakingRate": 1
                },
                "input": {
                    "text": text
                },
                "voice": {
                    "languageCode": "ro-RO",
                    "name": "ro-RO-Wavenet-A"
                }
            })
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error, status = ${response.status}`);
                }
                return response.json(); // base64 encoded
            })
            .then((json) => json.audioContent)
            .then((audioContent) => {
                if (audio) {
                    try {
                        audio.pause();
                    } catch (e) {
                    }
                }
                audio = new Audio("data:audio/wav;base64," + audioContent);
                audio.play();
            })
        ;
    }

    const aiPrompt = `Urmatorul text a fost scris intr-o aplicatie AAC apasand pe imagini.
    Gaseste o forma corecta gramatical, fara a adauga pe cat posibil cuvinte in plus sau repetitii.

 `;

    function simplifyText() {
        const gemini_api_key="AIzaSyDN4IzkS79NcW5E87kuwtCeJiuqYRp9gzk";

  //       curl \
  // -H "Content-Type: application/json" \
  // -d "{\"contents\":[{\"parts\":[{\"text\":\"Explain how AI works\"}]}]}" \
  // -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=YOUR_API_KEY"

        return fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=" + gemini_api_key, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                "contents": [{
                        "parts": [{"text": aiPrompt + textE.value}]
                }]
            })
        })
        .then((response) => {
            if (!response.ok) {
                throw new Error(`HTTP error, status = ${response.status}`);
            }
            return response.json();
        })
        .then((json) => {
            console.log(json);
            textE.value = json.candidates[0].content.parts[0].text;
        })
    }

    function speak() {
        speakGoogle(textE.value);
    }

    function speakOpenAI(text) {
        const audioCtx = new AudioContext();
        fetch("https://api.openai.com/v1/audio/speech", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${OPENAI_API_KEY}`,
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                model: "tts-1",
                // voice: "alloy",
                voice: "echo",
                input: text,
            })
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error, status = ${response.status}`);
                }
                return response.arrayBuffer();
            })
            .then((buffer) => audioCtx.decodeAudioData(buffer))
            .then((decodedData) => {
                const source = new AudioBufferSourceNode(audioCtx);
                source.buffer = decodedData;
                source.connect(audioCtx.destination);
                return source;
            })
            .then((source) => {
                source.start(0);
            });

    }
</script>
</body>
</html>
