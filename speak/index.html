<html>
<head>
    <title>Vorbeste, Vlad!</title>
    <link href="favicon3.png" rel="icon" type="image/png">
    <meta charset="UTF-8">
    <style>
        body {
            margin: 0.5%;
        }

        * {
            -webkit-touch-callout: none;
        }

        button {
            cursor: pointer;
            font-size: 20pt;
        }

        #text {
            font-size: 200%;
            padding: 5pt;
            width: 100%;
        }

        #bottom-button-bar {
            width: 100%;
            text-align: center;
            position: absolute;
            bottom: 0
        }

        #bottom-button-bar button {
            background-color: white;
            box-shadow: 0 0 5px 0;
        }

        :fullscreen, ::backdrop {
            background-color: rgba(255, 255, 255, 0);
            padding: 8px;
        }

        button.backspace {
            position: absolute;
            height: 41pt;
            width: 80pt;
            right: 0;
            margin-right: 0.5%;
        }

        div#canvas {
            background: white;
        }

        div#canvas img, div#images img {
            /*width: 12.5%;*/
            width: 16.66%;
            display: inline-block;
            box-sizing: border-box;
            border: 5px solid lightgrey;
        }

    </style>
</head>
<body>
<div id="bottom-button-bar">
    <button autofocus id="fullscreen-button" onclick="document.body.requestFullscreen(); this.style.display='none';">
        Fullscreen
    </button>
    <!--<button onclick="speakOpenAI(document.getElementById('text').value || 'Vreau să dorm!')"> Speak OpenAI️</button>-->
    <button onclick="speakGoogle(document.getElementById('text').value || 'Vreau să dorm!')"> Speak Google</button>
</div>
<input id="text" readonly="readonly" type="text"/>
<button class="backspace"
        onclick="stergeTot(); event.returnValue = false;"
        ontouchstart="stergeTot(); event.returnValue = false;"
> ⌫
    <!--        ontouchstart="stergeCuvant(); event.returnValue = false;"-->
    <!--        ontouchend="onStergeDown();event.returnValue = false;"-->
    <!--        ontouchmove="event.returnValue = false;"-->
    <!--        ontouchcancel="event.returnValue = false;"-->
    <!--        onclick="stergeCuvant();event.returnValue = false;"-->
    <!--        onmousedown="onStergeDown();event.returnValue = false;"-->

</button>
<br>
<div id="canvas">

</div>
<div id="images">

</div>


<!--<img src="bed.png" onerror="errors.push(src)">-->

<script>

    //https://stackoverflow.com/questions/42160260/prevent-force-touch-event-on-image-but-still-allow-long-press-event-in-ios-safar
    window.addEventListener('touchforcechange', function (event) {
        var force = event.changedTouches[0].force;
        var id = event.changedTouches[0].target.id;

        if ($('#' + id).hasClass('class') && force > 0.1) {
            event.preventDefault();
            console.log('prevented 3D touch on element with id = ' + id);
        }
    });


    const textE = document.getElementById('text');
    const itemsPerPage = 18;
    const topItems = [
        {
            img: 'eat.jpg', text: 'vreau', children: [
                {img: 'banana.jpg', text: 'banană'},
                {img: 'sticks.jpg', text: 'sticks'},
                {img: 'lays.jpg', text: 'lays'},
                {img: 'pomber.jpg', text: 'pomber'},
                {img: 'eggs.jpg', text: 'ouă'},
                {img: 'bread-butter.png', text: 'pâine cu unt'},
                {img: 'grape.jpg', text: 'struguri'},
                {img: 'apple.jpg', text: 'măr'},
                {img: 'soup.jpg', text: 'supă'},
                {img: 'blueberry.jpg', text: 'afine'},
                {img: 'pure.png', text: 'piure'},
                {img: 'pasta.png', text: 'paste'},
                {img: 'pizza.png', text: 'pizza'},
                {img: 'strawberry.png', text: 'căpșuni'},
                {img: 'iogurt.png', text: 'iaurt'},
            ]
        },
        {
            img: 'drink.jpg', text: 'vreau să beau', children: [
                {img: 'water.jpg', text: 'apă'},
                {img: 'milk.jpg', text: 'lapte'},
                {img: 'tea.jpg', text: 'ceai'},
                {img: 'juice.png', text: 'suc'},
            ]
        },
        {
            text: 'vreau', img: 'want.jpg', children: [
                {img: 'bombons.png', text: 'bomboane'},
                {img: 'outside.png', text: 'să merg'},
                {img: 'sleep.jpg', text: 'să dorm'},
                {img: 'mom.jpg', text: 'la mama'},
                {img: 'dad.jpg', text: 'la tata'},
                {img: 'emma.jpg', text: 'Emma'},
                {img: 'hug.png', text: 'pupă'},
                {img: 'bath.jpg', text: 'baie'},
                {img: 'wc.jpg', text: 'toaletă'},
                {img: 'music.jpg', text: 'muzică'},
                {img: 'book.png', text: 'carte'},
                {img: 'toys.png', text: 'jucării'},
                {img: 'board.png', text: 'placă'},
                {img: 'd.png', text: 'D'},
                {img: 'phone.png', text: 'telefon'},
                {img: 'my-room.png', text: 'acasă'},

            ]
        },
        {
            img: 'feel.jpg', text: "mă simt", children: [
                {img: 'happy.png', text: 'fericit'},
                {img: 'sad.png', text: 'trist'},
                {img: 'cold.jpg', text: 'mi-e rece'},
                {img: 'hot.jpg', text: 'mi-e cald'},
                {img: 'angry.png', text: 'supărat'},
                {img: 'wet.jpg', text: 'ud'},
                {
                    img: 'auch.jpg', text: 'mă doare', children: [
                        {img: 'hand.png', text: 'mâna'},
                        {img: 'foot.png', text: 'picior'},
                        {img: 'head.png', text: 'cap'},
                        {img: 'teeth.png', text: 'dinți'},
                        {img: 'throat.png', text: 'gât'},
                        {img: 'ear.png', text: 'ureche'},
                        {img: 'belly.png', text: 'burtă'},
                    ]
                },
            ]
        },
        {img: 'enough.jpg', text: 'gata'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'white.jpg'},
        {img: 'yes.jpg', text: 'da'},
        {img: 'no.jpg', text: 'nu'},
    ];
    const homeItem = {img: 'home.png', children: topItems};

    function addHome(items) {
        for (let item of items) {
            if (item.children) {
                addHome(item.children);
            }
        }
        while (items.length < itemsPerPage - 1) {
            items.push({img: 'white.jpg'});
        }
        items.push(homeItem);
    }

    addHome(topItems);

    const canvasE = document.getElementById('canvas');

    function checkImages(items) {
        for (let item of items) {
            canvasE.innerHTML = '';
            if (item.children) {
                checkImages(item.children);
            }
        }
    }

    var imgPressTimer = null;

    function setCanvas(items) {
        canvasE.innerHTML = '';
        for (let item of items) {
            let img = document.createElement('img');
            img.src = item.img;
            img.onclick = function () {
                if (item.text) prompt(item.text);
                if (item.children) setCanvas(item.children);
                else if (item.text) {
                    setCanvas(topItems);
                    speak();
                }
            }
            img.onmousedown = function (e) {
                imgPressTimer = setTimeout(() => {
                    img.onclick();
                    speakGoogle(textE.value);
                }, 500);
                e.preventDefault();
            }
            img.onmouseup = function () {
                clearTimeout(imgPressTimer);
                e.preventDefault();
            }
            canvasE.appendChild(img);
        }
    }

    setCanvas(topItems);


    // remove spaces between <img> <img>
    const imagesE = document.getElementById('images');
    imagesE.innerHTML = imagesE.innerHTML.replace(/>\s+</g, '><');
    for (let img of imagesE.children) {
        img.onclick = function () {
            prompt(img.alt);
        }
    }


    function prompt(text) {
        textE.value += ' ' + text;
    }

    function stergeTot() {
        textE.value = "";
    }

    function stergeCuvant() {
        let pozitieUltimSpatiu = textE.value.lastIndexOf(" ");
        textE.value = textE.value.substring(0, pozitieUltimSpatiu);
        clearTimeout(timerDown);
    }

    var timerDown = null;

    function onStergeDown() {
        timerDown = setTimeout(() => {
            textE.value = "";
        }, 500);
    }

    document.onfullscreenchange = function () {
        if (!document.fullscreenElement) {
            let button = document.querySelector('#fullscreen-button');
            button.style.display = 'inline';
            button.focus();
        }
    }

    var googleRequest = null;

    function speakGoogle(text) {
        const googleApiKey = "AIzaSyDCRBksTm_8-MB-xr55MasWtXUyFpnd3Kc";
        if (googleRequest) {
            try {
                googleRequest.abort();
            } catch (e) {
            }
        }
        googleRequest = fetch("https://texttospeech.googleapis.com/v1/text:synthesize?key=" + googleApiKey, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                "audioConfig": {
                    "audioEncoding": "LINEAR16",
                    "effectsProfileId": [
                        "small-bluetooth-speaker-class-device"
                    ],
                    "pitch": 0,
                    "speakingRate": 1
                },
                "input": {
                    "text": text
                },
                "voice": {
                    "languageCode": "ro-RO",
                    "name": "ro-RO-Wavenet-A"
                }
            })
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error, status = ${response.status}`);
                }
                return response.json(); // base64 encoded
            })
            .then((json) => json.audioContent)
            .then((audioContent) => {
                const audio = new Audio("data:audio/wav;base64," + audioContent);
                audio.play();
            })
        ;
    }

    function speak() {
        speakGoogle(textE.value);
    }

    function speakOpenAI(text) {
        const audioCtx = new AudioContext();
        fetch("https://api.openai.com/v1/audio/speech", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${OPENAI_API_KEY}`,
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                model: "tts-1",
                // voice: "alloy",
                voice: "echo",
                input: text,
            })
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error, status = ${response.status}`);
                }
                return response.arrayBuffer();
            })
            .then((buffer) => audioCtx.decodeAudioData(buffer))
            .then((decodedData) => {
                const source = new AudioBufferSourceNode(audioCtx);
                source.buffer = decodedData;
                source.connect(audioCtx.destination);
                return source;
            })
            .then((source) => {
                source.start(0);
            });

    }
</script>
</body>
</html>
